#!/usr/bin/env python3

import paths
import parse

def verbose_reduce(expr, symbols):
    while True:
        print("    ", expr)
        next = expr.reduce_once(symbols)
        if next is None:
            return expr
        expr = next

def main():
    testfiles = paths.top / "testfiles"
    for tf in testfiles.iterdir():
        print(f"==== {tf}")
        symbols = {}
        directives = parse.parse_directives(tf.read_text())
        for d in directives.children:
            if d.data == "let":
                name, value = d.children
                symbols[name.value] = value
                print(f"let {name.value}")
            elif d.data == "test":
                left = verbose_reduce(d.children[0], symbols)
                print()
                right = verbose_reduce(d.children[1], symbols)
                print()
                print("Equiv?", left.equiv(right))
                print()

if __name__ == '__main__':
    main()
